<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barreto App</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont;
  background:#f2f2f7;
}

.container{
  max-width:430px;
  margin:auto;
  padding:20px;
}

.card{
  background:white;
  padding:20px;
  border-radius:20px;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
  margin-bottom:20px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:16px;
}

button{
  background:black;
  color:white;
  border:none;
  cursor:pointer;
}

h2{
  text-align:center;
}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div id="loginScreen" class="card">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="register()">Criar Conta</button>
</div>

<!-- APP -->
<div id="appScreen" style="display:none;">

<div class="card">
<h2>Cadastro Cliente</h2>
<input type="text" id="nome" placeholder="Nome">
<input type="text" id="telefone" placeholder="Telefone">
<input type="text" id="cep" placeholder="CEP">

<select id="tipo">
  <option value="">Tipo de imóvel</option>
  <option value="Casa">Casa</option>
  <option value="Apartamento">Apartamento</option>
</select>

<input type="text" id="numero" placeholder="Número">
<input type="text" id="complemento" placeholder="Complemento (Bloco / Apto)">

<input type="text" id="rua" placeholder="Rua">
<input type="text" id="bairro" placeholder="Bairro">
<input type="text" id="cidade" placeholder="Cidade">
<button onclick="salvarCliente()">Salvar</button>
</div>

<div class="card">
<h2>Buscar Cliente</h2>
<input type="text" id="busca" placeholder="Digite o nome">
<button onclick="buscarCliente()">Buscar</button>
<div id="resultado"></div>
</div>

<div id="areaServicos" class="card" style="display:none;">
  <h2>Serviços do Cliente</h2>

  <input type="text" id="descricaoServico" placeholder="Descrição do serviço">
  <input type="date" id="dataServico">
  <input type="number" id="valorServico" placeholder="Valor">
  
  <select id="statusServico">
    <option value="Pendente">Pendente</option>
    <option value="Pago">Pago</option>
  </select>

  <button onclick="salvarServico()">Salvar Serviço</button>

  <div id="listaServicos"></div>
</div>
  
<button onclick="logout()">Sair</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBP8lpsBu0QX6ROmK7Ligb9s9XvunBppzA",
  authDomain: "barreto-f590b.firebaseapp.com",
  projectId: "barreto-f590b",
  storageBucket: "barreto-f590b.firebasestorage.app",
  messagingSenderId: "780260431308",
  appId: "1:780260431308:web:71f990a107e4cc62db7969"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let clienteEditandoId = null;  

/* LOGIN */

window.login = async function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  await signInWithEmailAndPassword(auth,email,password);
}

window.register = async function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  await createUserWithEmailAndPassword(auth,email,password);
}

window.logout = async function(){
  await signOut(auth);
  location.reload();
}

onAuthStateChanged(auth,(user)=>{
  if(user){
    loginScreen.style.display="none";
    appScreen.style.display="block";
  }else{
    loginScreen.style.display="block";
    appScreen.style.display="none";
  }
});

/* SALVAR CLIENTE */

window.salvarCliente = async function(){
  try{

    const dados = {
      nome:nome.value,
      telefone:telefone.value,
      cep:cep.value,
      tipo:tipo.value,
      numero:numero.value,
      complemento:complemento.value,
      rua:rua.value,
      bairro:bairro.value,
      cidade:cidade.value
    };

    if(clienteEditandoId){

      const clienteRef = doc(db,"clientes",clienteEditandoId);
      await updateDoc(clienteRef,dados);

      alert("Cliente atualizado com sucesso!");
      clienteEditandoId = null;

    }else{

      await addDoc(collection(db,"clientes"),dados);
      alert("Cliente salvo com sucesso!");

    }

    // limpar formulário
    nome.value="";
    telefone.value="";
    cep.value="";
    tipo.value="";
    numero.value="";
    complemento.value="";
    rua.value="";
    bairro.value="";
    cidade.value="";

  }catch(erro){
    alert("Erro: " + erro.message);
  }
}
  
/* BUSCAR CLIENTE */

window.buscarCliente = async function(){
  const q = query(collection(db,"clientes"),where("nome","==",busca.value));
  const querySnapshot = await getDocs(q);

  resultado.innerHTML="";

  querySnapshot.forEach((docSnap)=>{
    const cliente = docSnap.data();
    const id = docSnap.id;

    resultado.innerHTML += `
      <div style="background:white; padding:15px; margin-top:10px; border-radius:15px; box-shadow:0 3px 10px rgba(0,0,0,0.1);">
        <strong>${cliente.nome}</strong><br>
        ${cliente.telefone}<br><br>
        <button onclick="carregarParaEdicao('${id}')">Editar</button>
<button onclick="excluirCliente('${id}')" style="background:red; margin-top:5px;">
Excluir
</button>
<button onclick="abrirServicos('${id}','${cliente.nome}')"
style="background:#007aff; margin-top:5px;">
Serviços
</button>
      </div>
    `;
  });
}

window.carregarParaEdicao = async function(id){

  const clienteRef = doc(db,"clientes",id);
  const clienteSnap = await getDocs(
    query(collection(db,"clientes"), where("__name__","==",id))
  );

  clienteSnap.forEach((docSnap)=>{
    const c = docSnap.data();

    nome.value = c.nome || "";
    telefone.value = c.telefone || "";
    cep.value = c.cep || "";
    tipo.value = c.tipo || "";
    numero.value = c.numero || "";
    complemento.value = c.complemento || "";
    rua.value = c.rua || "";
    bairro.value = c.bairro || "";
    cidade.value = c.cidade || "";
  });

  clienteEditandoId = id;

}
  
window.abrirCliente = function(nome,telefone,cep,rua,bairro,cidade){
  alert(
    "Nome: " + nome + "\n\n" +
    "Telefone: " + telefone + "\n\n" +
    "CEP: " + cep + "\n" +
    "Rua: " + rua + "\n" +
    "Bairro: " + bairro + "\n" +
    "Cidade: " + cidade
  );
}

window.excluirCliente = async function(id){

let clienteServicoId = null;

window.abrirServicos = async function(id, nome){

  clienteServicoId = id;

  document.getElementById("areaServicos").style.display = "block";

  await listarServicos();

}  

window.listarServicos = async function(){

  const q = query(
    collection(db,"servicos"),
    where("clienteId","==",clienteServicoId)
  );

  const querySnapshot = await getDocs(q);

  const lista = document.getElementById("listaServicos");
  lista.innerHTML="";

  querySnapshot.forEach((docSnap)=>{
    const s = docSnap.data();

    lista.innerHTML += `
      <div style="margin-top:10px; padding:10px; background:#f2f2f7; border-radius:10px;">
        <strong>${s.descricao}</strong><br>
        Data: ${s.data}<br>
        Valor: R$ ${s.valor}<br>
        Status: ${s.status}
      </div>
    `;
  });

}
  
  const confirmar = confirm("Tem certeza que deseja excluir este cliente?");

  if(!confirmar) return;

  try{

    const clienteRef = doc(db,"clientes",id);
    await deleteDoc(clienteRef);

    alert("Cliente excluído com sucesso!");

    buscarCliente();

  }catch(erro){
    alert("Erro ao excluir: " + erro.message);
  }

}  

let clienteServicoId = null;

window.abrirServicos = async function(id, nome){

  clienteServicoId = id;

  const area = document.getElementById("areaServicos");

  if(area){
    area.style.display = "block";
  }

  if(typeof listarServicos === "function"){
    await listarServicos();
  }

}

window.salvarServico = async function(){

  try{

    await addDoc(collection(db,"servicos"),{
      clienteId: clienteServicoId,
      descricao: document.getElementById("descricaoServico").value,
      data: document.getElementById("dataServico").value,
      valor: document.getElementById("valorServico").value,
      status: document.getElementById("statusServico").value
    });

    alert("Serviço salvo com sucesso!");

    document.getElementById("descricaoServico").value = "";
    document.getElementById("dataServico").value = "";
    document.getElementById("valorServico").value = "";
    document.getElementById("statusServico").value = "Pendente";

    listarServicos();

window.salvarServico = async function(){

  try{

    await addDoc(collection(db,"servicos"),{
      clienteId: clienteServicoId,
      descricao: document.getElementById("descricaoServico").value,
      data: document.getElementById("dataServico").value,
      valor: document.getElementById("valorServico").value,
      status: document.getElementById("statusServico").value
    });

    alert("Serviço salvo com sucesso!");

    document.getElementById("descricaoServico").value = "";
    document.getElementById("dataServico").value = "";
    document.getElementById("valorServico").value = "";
    document.getElementById("statusServico").value = "Pendente";

    listarServicos();

  }catch(erro){
    alert("Erro ao salvar serviço: " + erro.message);
  }

};

const telefoneInput = document.getElementById("telefone");

telefoneInput.addEventListener("input", function(){
  let t = telefoneInput.value.replace(/\D/g,"");

  if (t.length > 10) {
    telefoneInput.value = `(${t.slice(0,2)}) ${t.slice(2,3)} ${t.slice(3,7)}-${t.slice(7,11)}`;
  } else if (t.length > 6) {
    telefoneInput.value = `(${t.slice(0,2)}) ${t.slice(2,6)}-${t.slice(6)}`;
  } else if (t.length > 2) {
    telefoneInput.value = `(${t.slice(0,2)}) ${t.slice(2)}`;
  } else {
    telefoneInput.value = t;
  }
});
    
/* CEP AUTOMÁTICO */

const cepInput = document.getElementById("cep");
const ruaInput = document.getElementById("rua");
const bairroInput = document.getElementById("bairro");
const cidadeInput = document.getElementById("cidade");

cepInput.addEventListener("blur", async () => {
  const valor = cepInput.value.replace(/\D/g, "");
  if (valor.length === 8) {
    try {
      const resposta = await fetch(`https://viacep.com.br/ws/${valor}/json/`);
      const dados = await resposta.json();
      ruaInput.value = dados.logradouro || "";
      bairroInput.value = dados.bairro || "";
      cidadeInput.value = dados.localidade || "";
    } catch {
      alert("Erro ao buscar CEP");
    }
  }
});

/* TELEFONE AUTOMÁTICO */

const telefoneInput = document.getElementById("telefone");

telefoneInput.addEventListener("input", () => {
  let t = telefoneInput.value.replace(/\D/g, "");

  if (t.length > 11) t = t.slice(0, 11);
  
</script>
</body>
</html>
